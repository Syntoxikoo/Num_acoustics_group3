function [rzb38,topology38,rzline38,IndMb38,IndBP38,Mmb38,M38,N38,Tm38,mu_m38,...
          rzb39,topology39,rzline39,IndMb39,IndBP39,Mmb39,M39,N39,Tm39,mu_m39,Rad,BPrad,...
          rzbEXT,topologyEXT,Mext,Next,IndMbEXT,MmbEXT]=geom_BK4938_9_VER4c(MeshDens)

% This function produces the geometry and physical parameters of the Brüel&Kjær
% microphones 4938 and 4939. 
% The input parameter is the mesh density.
% The output contains, for each microphone: node and element matrices,
% indices of the membrane nodes, number of nodes and elements, membrane
% tension and menbrane surface density, in this order.
%
% Rounded edges are used, with adjustable curvature radius.

% Vicente Cutanda Henríquez 03-2011

% VER4c: (4-2012)
% NEW: IntF2 is an earlier version providing better accuracy
% NEW: IntF1 (nonsingular) is also refined with near-singular integration
% Hgh=19.8e-6;


% Physical dimensions of the microphone's interior, not counting the cavity around.
% Membrane radius is 2 mm, gap thickness is 18e-6 and backplate radius is 1.75 mm
% for microphones 4938 and 4939.
Hgh=19.8e-6; % Other values: 11e-6 - 24e-6
Rad=2e-3; 
BPrad=1.75e-3;
Rc=3e-5; %5e-5;1e-5; Radius of rounded corners

% Generator of microphones 4938 and 4839, from B&K drawings.

segments4938=[0 Hgh BPrad Hgh 42 0 MeshDens;...
          BPrad Hgh Rad Hgh 6 0 MeshDens;...
          Rad Hgh Rad+Rc Hgh-Rc 5 Rc MeshDens;...
          Rad+Rc Hgh-Rc Rad+Rc -0.75e-3+Rc 4 0 MeshDens;...
          Rad+Rc -0.75e-3+Rc Rad -0.75e-3 5 Rc MeshDens;...
          Rad -0.75e-3 1.8e-3+Rc -0.75e-3 2 0 MeshDens;...
          1.8e-3+Rc -0.75e-3 1.8e-3 -0.75e-3-Rc 5 -Rc MeshDens;...
          1.8e-3 -0.75e-3-Rc 1.8e-3 -1.5e-3+Rc 4 0 MeshDens;...
          1.8e-3 -1.5e-3+Rc 1.8e-3-Rc -1.5e-3 5 Rc MeshDens;...
          1.8e-3-Rc -1.5e-3 1.3e-3+Rc -1.5e-3 3 0 MeshDens;...
          1.3e-3+Rc -1.5e-3 1.3e-3 -1.5e-3+Rc 5 -Rc MeshDens;...
          1.3e-3 -1.5e-3+Rc 1.3e-3 -0.5e-3-Rc 4 0 MeshDens;...
          1.3e-3 -0.5e-3-Rc 1.3e-3+Rc -0.5e-3 5 Rc MeshDens;...
          1.3e-3+Rc -0.5e-3 BPrad -0.5e-3 3 0 MeshDens;...
          BPrad -0.5e-3 BPrad+Rc -0.5e-3+Rc 5 -Rc MeshDens;...
          BPrad+Rc -0.5e-3+Rc BPrad+Rc -Rc 3 0 MeshDens;...
          BPrad+Rc -Rc BPrad 0 5 Rc MeshDens;...
          BPrad 0 0 0 42 0 MeshDens];
       
segments4939=[0 Hgh BPrad Hgh 42 0 MeshDens;...
          BPrad Hgh Rad Hgh 6 0 MeshDens;...
          Rad Hgh Rad+Rc Hgh-Rc 5 Rc MeshDens;...
          Rad+Rc Hgh-Rc Rad+Rc -0.75e-3+Rc 4 0 MeshDens;...
          Rad+Rc -0.75e-3+Rc Rad -0.75e-3 5 Rc MeshDens;...
          Rad -0.75e-3 1.8e-3+Rc -0.75e-3 2 0 MeshDens;...
          1.8e-3+Rc -0.75e-3 1.8e-3 -0.75e-3-Rc 5 -Rc MeshDens;...
          1.8e-3 -0.75e-3-Rc 1.8e-3 -3.5e-3+Rc 6 0 MeshDens;...
          1.8e-3 -3.5e-3+Rc 1.8e-3-Rc -3.5e-3 5 Rc MeshDens;...
          1.8e-3-Rc -3.5e-3 1.3e-3+Rc -3.5e-3 2 0 MeshDens;...
          1.3e-3+Rc -3.5e-3 1.3e-3 -3.5e-3+Rc 5 -Rc MeshDens;...
          1.3e-3 -3.5e-3+Rc 1.3e-3 -3.1e-3-Rc 2 0 MeshDens;...
          1.3e-3 -3.1e-3-Rc 1.3e-3-Rc -3.1e-3 5 Rc MeshDens;...
           1.3e-3-Rc -3.1e-3 1.2e-3+Rc -3.1e-3 2 0  MeshDens;...
          1.2e-3+Rc -3.1e-3 1.2e-3 -3.1e-3+Rc 5 -Rc MeshDens;...
           1.2e-3 -3.1e-3+Rc 1.2e-3 -0.9e-3-Rc 5 0 MeshDens;... 
          1.2e-3 -0.9e-3-Rc 1.2e-3+Rc -0.9e-3 5 Rc MeshDens;...
           1.2e-3+Rc -0.9e-3 1.3e-3-Rc -0.9e-3 2 0 MeshDens;...
          1.3e-3-Rc -0.9e-3 1.3e-3 -0.9e-3+Rc 5 -Rc MeshDens;...
          1.3e-3 -0.9e-3+Rc 1.3e-3 -0.5e-3-Rc 2 0 MeshDens;...
          1.3e-3 -0.5e-3-Rc 1.3e-3+Rc -0.5e-3 5 Rc MeshDens;...
          1.3e-3+Rc -0.5e-3 BPrad -0.5e-3 3 0 MeshDens;...
          BPrad -0.5e-3 BPrad+Rc -0.5e-3+Rc 5 -Rc MeshDens;...
          BPrad+Rc -0.5e-3+Rc BPrad+Rc -Rc 3 0 MeshDens;...
          BPrad+Rc -Rc BPrad 0 5 Rc MeshDens;...
          BPrad 0 0 0 42 0 MeshDens];
       
[rzb38,topology38,rzline38]=nodegen(segments4938,'n'); %hh38=gcf;
[rzb39,topology39,rzline39]=nodegen(segments4939,'n'); %hh39=gcf;

M38=size(rzb38,1);N38=size(topology38,1);
M39=size(rzb39,1);N39=size(topology39,1);

% indicate interior domain
rzb38(:,end)=-rzb38(:,end);
rzb39(:,end)=-rzb39(:,end);
topology38(:,end)=-topology38(:,end);
topology39(:,end)=-topology39(:,end);


% find nodes on the membrane (4938):
IndMb38=find(rzb38(:,2)>Hgh-eps & rzb38(:,2)<Hgh+eps & rzb38(:,1)<=Rad*(1+eps));
Mmb38=length(IndMb38);
IndBP38=find(rzb38(:,2)>Hgh-eps & rzb38(:,2)<Hgh+eps & rzb38(:,1)<=BPrad*(1+eps));
% %IndBack38=find(rzb38(:,2)>-eps & rzb38(:,2)<+eps & rzb38(:,1)<=Rad*(1+eps));IndBack38=IndBack38(end:-1:1);
% figure(hh38);hold on
% plot(rzb38(IndMb38,1),rzb38(IndMb38,2),'g*')
% %plot(rzb38(IndBack38,1),rzb38(IndBack38,2),'b*')
% hold off

% find nodes on the membrane (4939):
IndMb39=find(rzb39(:,2)>Hgh-eps & rzb39(:,2)<Hgh+eps & rzb39(:,1)<=Rad*(1+eps)); % not ordered, but by chance they are
Mmb39=length(IndMb39);
IndBP39=find(rzb39(:,2)>Hgh-eps & rzb39(:,2)<Hgh+eps & rzb39(:,1)<=BPrad*(1+eps));
% %IndBack39=find(rzb39(:,2)>-eps & rzb39(:,2)<+eps & rzb39(:,1)<=Rad*(1+eps));IndBack39=IndBack39(end:-1:1);
% figure(hh39);hold on
% plot(rzb39(IndMb39,1),rzb39(IndMb39,2),'g*')
% %plot(rzb39(IndBack39,1),rzb39(IndBack39,2),'b*')
% hold off

% specific parameters for the diaphragms, mics [4938 4939], used in solving process.
Tm38=3128; Tm39=1039; %[5700 3450] [4000 1200] tension, originally [3128 1039]. 
% [5700 3450] give vacuum resonances of 60 and 80 kHz, respectively for 4938 and 4839 mics.
mu_m38=8300*6.95e-6; mu_m39=8300*2.35e-6;% surface density, density*thickness 8300*[6.95e-6 2.35e-6]



% EXTERIOR DOMAIN:

Rext=3.175e-3;   % Exterior radius of the microphone
Lext= 50e-3;     % Length of the microphone+amplifier body
ElMemBckp=42;  % Number of elements over the membrane and backplate

segments49EXT=[0 Hgh BPrad Hgh ElMemBckp 0 MeshDens;...
          BPrad Hgh Rad Hgh round(ElMemBckp*(Rad-BPrad)/BPrad) 0 MeshDens;...
          Rad Hgh Rext Hgh round(ElMemBckp*(Rext-Rad)/BPrad) 0 MeshDens;...
          Rext Hgh Rext -Lext 100 0 MeshDens;...
          Rext -Lext 0 -Lext-Rext 10 Rext MeshDens];

[rzbEXT,topologyEXT]=nodegen(segments49EXT,'n'); %hh38=gcf;

Mext=size(rzbEXT,1);Next=size(topologyEXT,1);

% find nodes on the membrane (EXT):
IndMbEXT=find(rzbEXT(:,2)>Hgh-eps & rzbEXT(:,2)<Hgh+eps & rzbEXT(:,1)<=Rad*(1+eps));
MmbEXT=length(IndMbEXT);

end

